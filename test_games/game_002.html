<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvest Rush</title>
    <style>
        :root {
            --bg-color: #e8f5e9;
            --grid-bg: #8d6e63;
            --cell-bg: #d7ccc8;
            --primary: #2e7d32;
            --accent: #ff6f00;
            --text: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        h1 { margin: 10px 0; color: var(--primary); }

        /* HUD */
        .hud {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .hud span { color: var(--primary); }
        .hud .timer { color: var(--accent); }

        /* Game Board */
        .garden-container {
            background-color: var(--grid-bg);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-template-rows: repeat(8, 50px);
            gap: 4px;
        }

        .cell {
            width: 50px;
            height: 50px;
            background-color: var(--cell-bg);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .cell:hover {
            filter: brightness(1.1);
        }

        /* Selection Styling */
        .cell.selected {
            background-color: #fff9c4;
            box-shadow: inset 0 0 0 3px var(--accent);
            transform: scale(0.95);
        }

        /* Progress Bar for Plant Growth (optional visual cue) */
        .growth-bar {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        .growth-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s linear;
        }

        /* Controls */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.95); }

        #btn-harvest {
            background-color: var(--accent);
            color: white;
        }
        #btn-harvest:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #btn-restart {
            background-color: var(--primary);
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .hidden { display: none; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        
        .modal-title { font-size: 2rem; margin-bottom: 10px; }
        .win { color: var(--primary); }
        .lose { color: #d32f2f; }

    </style>
</head>
<body>

    <h1>Harvest Rush</h1>

    <div class="hud">
        <div>Time: <span id="timer" class="timer">60</span>s</div>
        <div>Score: <span id="score">0</span></div>
        <div>Target: <span id="target">1000</span></div>
    </div>

    <div class="garden-container">
        <div id="grid" class="grid">
            <!-- Cells generated by JS -->
        </div>
    </div>

    <div class="controls">
        <button id="btn-harvest" disabled>Harvest Selected (0)</button>
        <button id="btn-restart">Restart Game</button>
    </div>

    <!-- Game Over Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modal-title" class="modal-title">Game Over</h2>
            <p id="modal-msg">Final Score: 0</p>
            <button onclick="initGame()">Play Again</button>
        </div>
    </div>

    <script>
        /**
         * CONFIGURATION & CONSTANTS
         */
        const GRID_SIZE = 8;
        const GAME_DURATION = 60; // seconds
        const TARGET_SCORE = 1500;
        const GROWTH_TICK = 1000; // ms between growth updates
        const POINTS_PER_PLANT = 10;
        
        // Plant definitions
        const PLANTS = [
            { id: 'carrot', matureEmoji: 'ü•ï', color: '#ffccbc' },
            { id: 'tomato', matureEmoji: 'üçÖ', color: '#ffcdd2' },
            { id: 'lettuce', matureEmoji: 'ü•¨', color: '#c8e6c9' }
        ];

        // Growth Stages
        const STAGE_SEED = 0;
        const STAGE_SPROUT = 1;
        const STAGE_MATURE = 2;
        
        const EMOJI_SEED = 'üå±';
        const EMOJI_SPROUT = 'üåø';

        /**
         * GAME STATE
         */
        let grid = []; // 8x8 array storing cell data
        let score = 0;
        let timeLeft = GAME_DURATION;
        let timerInterval = null;
        let growthInterval = null;
        let isGameActive = false;
        let selectedCells = []; // Array of {r, c}

        // DOM Elements
        const gridEl = document.getElementById('grid');
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const targetEl = document.getElementById('target');
        const harvestBtn = document.getElementById('btn-harvest');
        const restartBtn = document.getElementById('btn-restart');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');

        /**
         * INITIALIZATION
         */
        function initGame() {
            // Reset State
            score = 0;
            timeLeft = GAME_DURATION;
            isGameActive = true;
            selectedCells = [];
            grid = [];

            // Reset UI
            scoreEl.innerText = score;
            targetEl.innerText = TARGET_SCORE;
            timerEl.innerText = timeLeft;
            modal.classList.add('hidden');
            harvestBtn.disabled = true;
            harvestBtn.innerText = "Harvest Selected (0)";

            // Build Grid Data
            for (let r = 0; r < GRID_SIZE; r++) {
                const row = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    row.push(createNewPlant(true)); // Start with random maturity
                }
                grid.push(row);
            }

            // Render Board
            renderGrid();

            // Start Loops
            clearInterval(timerInterval);
            clearInterval(growthInterval);
            
            timerInterval = setInterval(gameTick, 1000);
            growthInterval = setInterval(growthTick, GROWTH_TICK);
        }

        function createNewPlant(randomStage = false) {
            const plantType = PLANTS[Math.floor(Math.random() * PLANTS.length)];
            let stage = STAGE_SEED;
            
            if (randomStage) {
                // Randomize start stage for variety
                stage = Math.floor(Math.random() * 3);
            }

            return {
                type: plantType,
                stage: stage,
                id: Math.random().toString(36).substr(2, 9),
                selected: false
            };
        }

        /**
         * GAME LOOP LOGIC
         */
        function gameTick() {
            if (!isGameActive) return;
            timeLeft--;
            timerEl.innerText = timeLeft;

            if (timeLeft <= 0) {
                endGame();
            }
        }

        function growthTick() {
            if (!isGameActive) return;
            
            let changed = false;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = grid[r][c];
                    // If not mature and not currently selected, grow
                    if (cell.stage < STAGE_MATURE && !cell.selected) {
                        // 30% chance to grow this tick to make it feel organic
                        if(Math.random() > 0.7) {
                            cell.stage++;
                            changed = true;
                            updateCellVisuals(r, c);
                        }
                    }
                }
            }
        }

        function endGame() {
            isGameActive = false;
            clearInterval(timerInterval);
            clearInterval(growthInterval);

            const won = score >= TARGET_SCORE;
            modalTitle.innerText = won ? "Harvest Complete!" : "Time's Up!";
            modalTitle.className = "modal-title " + (won ? "win" : "lose");
            modalMsg.innerText = `${won ? "You met the quota!" : "You didn't reach the target."} Score: ${score}`;
            modal.classList.remove('hidden');
        }

        /**
         * INTERACTION
         */
        function handleCellClick(r, c) {
            if (!isGameActive) return;

            const cell = grid[r][c];

            // Can only select mature plants
            if (cell.stage !== STAGE_MATURE) return;

            // If clicking an already selected cell, deselect everything
            if (cell.selected) {
                clearSelection();
                return;
            }

            // Clear previous selection if new group clicked
            clearSelection();

            // Find connected identical plants
            const group = findConnectedGroup(r, c, cell.type.id);
            
            if (group.length >= 3) {
                // Select them
                group.forEach(pos => {
                    grid[pos.r][pos.c].selected = true;
                    updateCellVisuals(pos.r, pos.c);
                });
                selectedCells = group;
                
                // Enable button
                harvestBtn.disabled = false;
                harvestBtn.innerText = `Harvest Selected (${group.length})`;
            }
        }

        // Flood fill algorithm to find connected components
        function findConnectedGroup(startR, startC, typeId) {
            const group = [];
            const visited = new Set();
            const queue = [{r: startR, c: startC}];
            
            while (queue.length > 0) {
                const {r, c} = queue.shift();
                const key = `${r},${c}`;

                if (visited.has(key)) continue;
                visited.add(key);

                // Check bounds
                if (r < 0 || r >= GRID_SIZE || c < 0 || c >= GRID_SIZE) continue;

                const target = grid[r][c];

                // Check match conditions: Same type, Mature
                if (target.type.id === typeId && target.stage === STAGE_MATURE) {
                    group.push({r, c});
                    
                    // Add neighbors
                    queue.push({r: r+1, c: c});
                    queue.push({r: r-1, c: c});
                    queue.push({r: r, c: c+1});
                    queue.push({r: r, c: c-1});
                }
            }
            return group;
        }

        function clearSelection() {
            selectedCells.forEach(pos => {
                grid[pos.r][pos.c].selected = false;
                updateCellVisuals(pos.r, pos.c);
            });
            selectedCells = [];
            harvestBtn.disabled = true;
            harvestBtn.innerText = "Harvest Selected (0)";
        }

        function harvestSelection() {
            if (selectedCells.length < 3) return;

            const points = selectedCells.length * POINTS_PER_PLANT;
            // Bonus for large groups
            const bonus = Math.floor(selectedCells.length / 5) * 20;
            score += (points + bonus);
            scoreEl.innerText = score;

            // Remove plants and replant seeds
            selectedCells.forEach(pos => {
                grid[pos.r][pos.c] = createNewPlant(false); // Reset to seed
                updateCellVisuals(pos.r, pos.c);
            });

            // Clear state
            selectedCells = [];
            harvestBtn.disabled = true;
            harvestBtn.innerText = "Harvest Selected (0)";
        }

        /**
         * RENDERING
         */
        function renderGrid() {
            gridEl.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    cellDiv.id = `cell-${r}-${c}`;
                    cellDiv.onclick = () => handleCellClick(r, c);
                    
                    // Growth bar
                    const barContainer = document.createElement('div');
                    barContainer.className = 'growth-bar';
                    const barFill = document.createElement('div');
                    barFill.className = 'growth-fill';
                    barContainer.appendChild(barFill);
                    cellDiv.appendChild(barContainer);

                    // Emoji Container
                    const emojiSpan = document.createElement('span');
                    cellDiv.appendChild(emojiSpan);

                    gridEl.appendChild(cellDiv);
                    updateCellVisuals(r, c);
                }
            }
        }

        function updateCellVisuals(r, c) {
            const data = grid[r][c];
            const el = document.getElementById(`cell-${r}-${c}`);
            if (!el) return;

            const emojiSpan = el.querySelector('span');
            const barFill = el.querySelector('.growth-fill');

            // Handle Selection State
            if (data.selected) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }

            // Handle Growth State
            if (data.stage === STAGE_SEED) {
                emojiSpan.innerText = EMOJI_SEED;
                el.style.backgroundColor = 'var(--cell-bg)';
                barFill.style.width = '33%';
            } else if (data.stage === STAGE_SPROUT) {
                emojiSpan.innerText = EMOJI_SPROUT;
                el.style.backgroundColor = '#dcedc8'; // slightly greener
                barFill.style.width = '66%';
            } else {
                emojiSpan.innerText = data.type.matureEmoji;
                el.style.backgroundColor = data.type.color; // Type specific color
                barFill.style.width = '100%';
            }
        }

        // Event Listeners
        harvestBtn.addEventListener('click', harvestSelection);
        restartBtn.addEventListener('click', initGame);

        // Start
        initGame();

    </script>
</body>
</html>